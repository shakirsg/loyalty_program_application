name: Build & Distribute Android APK

on:
  push:
    branches:
      - develop
    tags:
      - 'v*'

jobs:
  firebase-distribute:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'

      # - name: Decode google-services.json
      #   run: |
      #     mkdir -p android/app
      #     echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > android/app/google-services.json

      - name: Auto versioning
        run: .github/scripts/set_version.sh dev

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/key.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=key.jks" >> android/key.properties

      - name: Install dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      # - name: Run tests
      #   run: flutter test

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK with version
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/mfundi.apk

      # - name: Install Firebase CLI
      #   run: npm install -g firebase-tools

      # - name: Upload to Firebase App Distribution
      #   run: |
      #     firebase appdistribution:distribute build/app/outputs/flutter-apk/mfundi.apk \
      #       --app ${{ secrets.FIREBASE_APP_ID }} \
      #       --token ${{ secrets.FIREBASE_TOKEN }} \
      #       --groups testers
